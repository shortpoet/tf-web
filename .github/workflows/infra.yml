---
name: Infra

on:
  pull_request:
    branches:
      - main
      - uat
      - develop
    paths:
      - '.iac/**'
      - '.github/workflows/infra.yml'
      - '.github/workflows/changed-files.yml'
      - '.github/workflows/plan.yml'
      # - '.github/workflows/apply.yml'
      - '.github/actions/dump-context/action.yml'
      - '.github/actions/changed-files/action.yml'
      - '.github/actions/aws-creds/action.yml'
      # - 'app/**'
  push:
    branches:
      - main
      - uat
      - develop
    paths:
      - '.iac/**'
      - '.github/workflows/infra.yml'
      - '.github/workflows/changed-files.yml'
      - '.github/workflows/plan.yml'
      # - '.github/workflows/apply.yml'
      - '.github/actions/dump-context/action.yml'
      - '.github/actions/changed-files/action.yml'
      - '.github/actions/aws-creds/action.yml'
      # - 'app/**'
permissions:
  contents: read
  pull-requests: write

jobs:
  dump-context:
    runs-on: ubuntu-latest
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"

  # changed-files:
  #   uses: shortpoet/tf-web/.github/workflows/changed-files.yml@main

  # debug-changed-files:
  #   needs: changed-files
  #   runs-on: ubuntu-latest
  #   steps:
  #     # - name: dump context
  #     #   # reusable workflows should be referenced at the top-level `jobs.*.uses' key, not within steps
  #     #   # uses: shortpoet/tf-web/.github/workflows/dump-context.yml@main
  #     #   uses: shortpoet/tf-web/.github/actions/dump-context@main
  #     - name: dump changed files
  #       uses: shortpoet/tf-web/.github/actions/changed-files@main
  #       id: dump-changed-files
  #     - name: echo changed files needs
  #       run: |
  #         echo ${{ needs.changed-files.outputs.all }}
  #         echo ${{ needs.changed-files.outputs.tf }}
  #         echo ${{ needs.changed-files.outputs.yml }}
  #     - name: echo changed files steps
  #       run: |
  #         echo ${{ steps.dump-changed-files.outputs.all }}
  #         echo ${{ steps.dump-changed-files.outputs.tf }}
  #         echo ${{ steps.dump-changed-files.outputs.yml }}

      # - name: Check tag
      #   id: check-tag
      #   run: |
      #     if [[ ${{ github.ref }} =~ ^refs\/tags\/v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then echo ::set-output name=environment::production
      #     elif [[ ${{ github.ref }} == 'refs/heads/main' ]]; then echo ::set-output name=environment::staging
      #     else echo ::set-output name=environment::unknown
      #     fi

      # - name: Terraform Apply Global
      #   if: github.event_name == 'push' || github.event_name == 'release'
      #   working-directory: 07-managing-multiple-environments/file-structure/global
      #   run: |
      #     terraform init
      #     terraform apply -auto-approve

      # - name: Terraform Apply Staging
      #   if: steps.check-tag.outputs.environment == 'staging' && github.event_name == 'push'
      #   run: terraform apply -var db_pass=${{secrets.DB_PASS }} -auto-approve

      # - name: Terraform Apply Production
      #   if: steps.check-tag.outputs.environment == 'production' && github.event_name == 'release'
      #   working-directory: 07-managing-multiple-environments/file-structure/production
      #   run: |
      #     terraform init
      #     terraform apply -var db_pass=${{secrets.DB_PASS }} -auto-approve


  aws-plan-dev:
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    uses: ./.github/workflows/plan.yml
    secrets: inherit
    # uses: shortpoet/tf-web/.github/workflows/plan.yml@main
    with:
      provider: 'aws'
      gh_environment: 'dev'
      path: '.iac/aws/envs/dev/infra'

  aws-plan-uat:
      # github.event.pull_request.state == 'open' &&
      # github.event.pull_request.draft == false &&
      # github.event.pull_request.merged == false &&
      # github.event.pull_request.mergeable_state == 'clean' &&
      # github.event.pull_request.mergeable == true &&
      # github.event.pull_request.merge_state_status == 'clean' &&
      # github.event.pull_request.merge_commit_sha != '' &&
      # github.event.pull_request.merge_commit_sha != null
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.head.ref == 'develop' &&
      github.event.pull_request.base.ref == 'uat'
    uses: ./.github/workflows/plan.yml
    secrets: inherit
    # uses: shortpoet/tf-web/.github/workflows/plan.yml@main
    with:
      provider: 'aws'
      gh_environment: 'uat'
      path: '.iac/aws/envs/uat/infra'

  aws-plan-prod:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs : [aws-plan-uat]
    # needs : [aws-plan-dev, aws-plan-uat]
    uses: ./.github/workflows/plan.yml
    secrets: inherit
    # uses: shortpoet/tf-web/.github/workflows/plan.yml@main
    with:
      provider: 'aws'
      gh_environment: 'prod'
      path: '.iac/aws/envs/prod/infra'
