---
name: "AWS"
on:
  workflow_call:
    inputs:
      base_path:
        description: 'Specifies the path of the root terraform module.'
        required: true
        type: string
      infra_type:
        description: 'Specifies the type of deployment. Used for plan title.'
        required: true
        type: string

permissions:
  contents: read
  pull-requests: write

jobs:
  dump-context:
    runs-on: ubuntu-latest
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"

  check-tag:
    if: |
      startsWith(github.ref, 'refs/tags') &&
      (github.event_name == 'push' ||
      github.event_name == 'release')
    runs-on: ubuntu-latest
    outputs:
      has_tag: ${{ steps.check-tag.outputs.has_tag }}
    steps:
      - name: Check tag
        id: check-tag
        run: |
          has_tag=$([[ ${{ github.ref }} =~ ^refs\/tags\/v[0-9]+\.[0-9]+\.[0-9]+$ ]] && echo 'true' || echo 'false')
          echo "has_tag = $has_tag"
          echo "has_tag=$has_tag" >> $GITHUB_OUTPUT
  aws-creds:
    runs-on: ubuntu-latest
    steps:
      - name: AWS Credentials
        uses: ./.github/actions/aws-creds
        with:
          aws-profile: ${{ vars.AWS_PROFILE }}
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_DEFAULT_REGION }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          role-duration-seconds: 1200
  # build-title:
  #   runs-on: ubuntu-latest
  #   outputs:
  #     plan-title: ${{ steps.check-tag.outputs.has_tag }}
  #   steps:
  #     - name: Build Plan Title
  #       id: plan-title
  #       run: |
  #         plan_title="AWS ${{ inputs.gh_environment }} Deploy Plan"
  #         echo "plan_title=$has_tag" >> $GITHUB_OUTPUT

  aws-plan-dev:
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    uses: ./.github/workflows/plan.yml
    secrets: inherit
    needs: [aws-creds]
    # uses: shortpoet/tf-web/.github/workflows/plan.yml@main
    with:
      provider: 'aws'
      gh_environment: 'dev'
      path: ${{ inputs.base_path }}/envs/dev
      plan-title: "AWS ${{ inputs.gh_environment }} ${{ inputs.infra_type }} plan"

  aws-deploy-dev:
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    uses: ./.github/workflows/apply.yml
    secrets: inherit
    needs: [aws-plan-dev]
    with:
      provider: 'aws'
      gh_environment: 'dev'
      path: ${{ inputs.base_path }}/envs/dev

  aws-plan-uat:
    if: |
      (startsWith(github.ref, 'refs/pull') &&
      endsWith(github.ref, '/merge') &&
      github.head_ref == 'uat' &&
      github.base_ref == 'main' &&
      github.event_name == 'pull_request')
    uses: ./.github/workflows/plan.yml
    secrets: inherit
    with:
      provider: 'aws'
      gh_environment: 'uat'
      path: ${{ inputs.base_path }}/envs/uat
      plan-title: "AWS ${{ inputs.gh_environment }} ${{ inputs.infra_type }} plan"

  aws-deploy-uat:
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push'
    uses: ./.github/workflows/apply.yml
    secrets: inherit
    # needs: [aws-plan-uat, aws-deploy-dev]
    with:
      provider: 'aws'
      gh_environment: 'uat'
      path: ${{ inputs.base_path }}/envs/uat

  aws-plan-prod:
    if: |
      (needs.check-tag.outputs.has_tag == 'true' &&
      github.event_name == 'release')
    uses: ./.github/workflows/plan.yml
    secrets: inherit
    needs : [check-tag]
    # needs : [aws-deploy-uat, check-tag]
    with:
      provider: 'aws'
      gh_environment: 'prod'
      path: ${{ inputs.base_path }}/envs/prod
      plan-title: "AWS ${{ inputs.gh_environment }} ${{ inputs.infra_type }} plan"

  aws-deploy-prod:
    if: |
      needs.check-tag.outputs.has_tag == 'true' &&
      github.event_name == 'release'
    uses: ./.github/workflows/apply.yml
    secrets: inherit
    # needs : [check-tag]
    needs : [aws-plan-prod, check-tag]
    with:
      provider: 'aws'
      gh_environment: 'prod'
      path: ${{ inputs.base_path }}/envs/prod
